/* Bca tbj cso dul sfi 1 - Bai tap co so du lieu so 1.
Ica 26/11/2006, Tbs: Zng Tfy, Tcc: Kos Gre.
Mha ads teh seo lec hcr alxkhi@yahoo.com - Moi chi tiet xin lien he alxkhi@yahoo.com.
*/
--> Sfs, tbs lcc cso dul ALXKHI - Xoa, tao lai co so du lieu ALXKHI.
USE MASTER
GO

IF EXISTS (SELECT * FROM SYSDATABASES WHERE NAME = 'ALXKHI')
DROP DATABASE ALXKHI
GO

CREATE DATABASE ALXKHI
GO

--> Yeh lbj cfa I-Y-N - Thiet lap kieu ngay thang nam.
SET DATEFORMAT DMY
GO

--> Dka ALXKHI, tbs cbk bau dul - Dung ALXKHI, tao cac bang du lieu.
USE ALXKHI
GO

--> Bau DOCGIA
CREATE TABLE DOCGIA
(
	MADG	VARCHAR (12)	NOT NULL,
	HOTEN	VARCHAR (50)	NULL,
	DIACHI	VARCHAR (50)	NULL,
	PHONE	VARCHAR (12)	NULL,
CONSTRAINT PK_DOCGIA PRIMARY KEY (MADG)
)
GO

--> Bau SACH
CREATE TABLE SACH
(
	MASACH	VARCHAR (12)	NOT NULL,
	TENSACH	VARCHAR (50)	NULL,
	TACGIA	VARCHAR (50)	NULL,
	NXB	VARCHAR (12)	NULL,
	SOTRANG	INT		NULL,
CONSTRAINT PK_SACH PRIMARY KEY (MASACH)
)
GO

--> Bau NXBAN
CREATE TABLE NXBAN
(
	MANXB	VARCHAR (12)	NOT NULL,
	TENNXB	VARCHAR (50)	NULL,
	DIACHI	VARCHAR (50)	NULL,
	PHONE	VARCHAR (12)	NULL,
CONSTRAINT PK_NXB PRIMARY KEY (MANXB)
)
GO

--> Bau PHIEUMUON
CREATE TABLE PHIEUMUON
(
	MAPM		VARCHAR (12)	NOT NULL,
	MASACH		VARCHAR (12)	NOT NULL,
	MADG		VARCHAR (12)	NOT NULL,
	NGAYMUON	DATETIME	NULL,
	NGAYTRA		DATETIME	NULL,
	SOTIEN		INT		NULL,
CONSTRAINT PK_PHIEUMUON PRIMARY KEY (MAPM, MASACH, MADG)
)
GO

--> Tbs cbk efs igo - Tao cac khoa ngoai.
--> Bau SACH
ALTER TABLE SACH ADD
CONSTRAINT FK_SACH FOREIGN KEY (NXB)
REFERENCES NXBAN (MANXB)
GO

--> Bau PHIEUMUON
ALTER TABLE PHIEUMUON ADD
CONSTRAINT FK_PHIEUMUON_MASACH FOREIGN KEY (MASACH)
REFERENCES SACH (MASACH),
CONSTRAINT FK_PHIEUMUON_MADG FOREIGN KEY (MADG)
REFERENCES DOCGIA (MADG)
GO

--> Obj dul afc cbk bau - Nhap du lieu cho cac bang.
--> Bau DOCGIA
INSERT INTO DOCGIA
VALUES ('DG01', 'LA VAN CAU', '2 PHAM NGU LAO, Q1', '8890187')
GO

INSERT INTO DOCGIA
VALUES ('DG02', 'TRAN THI BUOI', '5 CO GIANG, QPN', '0908863145')
GO

INSERT INTO DOCGIA
VALUES ('DG03', 'VO VAN TRON', '10 CO BAC, QPN', '8888888')
GO

INSERT INTO DOCGIA
VALUES ('DG04', 'LE VAN TAI', '1 LE LAI, Q1', '8999999')
GO

INSERT INTO DOCGIA
VALUES ('DG05', 'LA VAN NGHICH', '4 LE LOI, Q1', '8555555')
GO

INSERT INTO DOCGIA
VALUES ('DG06', 'LE VAN MIT', '12 TRAN KHANH DU, Q1', '0913855855')
GO

--> Bau NXBAN
INSERT INTO NXBAN
VALUES ('GIAO DUC', 'NHA XUAT BAN GIAO DUC', 'SO 2 LE LAI', '8000000')
GO

INSERT INTO NXBAN
VALUES ('THONG KE', 'NHA XUAT BAN THONG KE', 'SO 3 LE LOI', '8123123')
GO

INSERT INTO NXBAN
VALUES ('KY THUAT', 'NHA XUAT BAN KY THUAT', 'SO 23 NGUYEN TRAI', '8321321')
GO

INSERT INTO NXBAN
VALUES ('KIM DONG', 'NHA XUAT BAN KIM DONG', 'SO 23 CO GIANG', '8456456')
GO

INSERT INTO NXBAN
VALUES ('TUOI TRE', 'NHA XUAT BAN TUOI TRE', 'SO 24 CO BAC', '8789789')
GO

--> Bau SACH
INSERT INTO SACH
VALUES ('CSDL', 'CO SO DU LIEU', 'THANH', 'GIAO DUC', 120)
GO

INSERT INTO SACH
VALUES ('CTDL', 'CAU TRUC DU LIEU', 'NHAN', 'THONG KE', 340)
GO

INSERT INTO SACH
VALUES ('TA1', 'TOAN A1', 'HUNG', 'GIAO DUC', 251)
GO

INSERT INTO SACH
VALUES ('TCB', 'TIN CO BAN', 'THANH', 'GIAO DUC', 123)
GO

INSERT INTO SACH
VALUES ('WORD', 'WORD 2000', 'PHONG', 'THONG KE', 86)
GO

--> Bau PHIEUMUON
INSERT INTO PHIEUMUON
VALUES ('PM001', 'CSDL', 'DG01', '22/3/2005', '27/3/2005', 10000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM001', 'CSDL', 'DG03', '12/5/05', '14/5/05', 4000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM002', 'TA1', 'DG03', '12/4/05', '22/4/05', 20000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM002', 'TCB', 'DG01', '2/3/05', '9/3/05', 14000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM001', 'TCB', 'DG02', '22/4/05', '29/4/05', 14000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM001', 'CSDL', 'DG04', '12/4/05', '20/4/05', 16000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM001', 'TA1', 'DG05', '2/3/05', '2/3/05', 2000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM001', 'TCB', 'DG06', '2/4/05', '5/4/05', 6000)
GO

INSERT INTO PHIEUMUON
VALUES ('PM002', 'CSDL', 'DG06', '2/4/05', '5/4/05', 6000)
GO

--> Alo vax dul - Truy van du lieu.
--> Cbt 01
--| Q = DOCGIA [*]
SELECT * FROM DOCGIA
GO

--> Cbt 02
--| Q = SACH [*]
SELECT * FROM SACH
GO

--> Cbt 03
--| Q = PHIEUMUON [*]
SELECT * FROM PHIEUMUON
GO

--> Cbt 04
--| Q = SACH: SOTRANG >= 101 [*]
SELECT * FROM SACH
WHERE SOTRANG >= 101
GO

--> Cbt 05
--| Q = DOCGIA: HOTEN = 'LE VAN MIT' [*]
SELECT * FROM DOCGIA
WHERE HOTEN = 'LE VAN MIT'
GO

--> Cbt 06
--| Q = DOCGIA: HOTEN LIKE 'LE%' [*]
SELECT * FROM DOCGIA
WHERE HOTEN LIKE 'LE%'
GO

--> Cbt 07
--| Q = DOCGIA: PHONE LIKE '8%' [*]
SELECT * FROM DOCGIA
WHERE PHONE LIKE '8%'
GO

--> Cbt 08
--| Q = PHIEUMUON: NGAYMUON = '22/04/2005' [*]
SELECT * FROM PHIEUMUON
WHERE NGAYMUON = '22/04/2005'
GO

--> Cbt 09
--| Q = SACH: TACGIA = 'THANH' [*]
SELECT * FROM SACH
WHERE TACGIA = 'THANH'
GO

--> Cbt 10
--| Q = PHIEUMUON: NGAYMUON = '22/04/2005 AND NGAYTRA = '29/04/2005' [*]
SELECT * FROM PHIEUMUON
WHERE NGAYMUON = '22/04/2005'
AND NGAYTRA = '29/04/2005'
GO

--> Cbt 11
--| Q = NXBAN: DIACHI = 'SO 2 LE LAI' OR PHONE = '8111111' [*]
SELECT * FROM NXBAN
WHERE DIACHI = 'SO 2 LE LAI'
OR PHONE = '8111111'
GO

--> Cbt 12
--| Q = PHIEUMUON: SOTIEN < 14000 [*]
SELECT * FROM PHIEUMUON
WHERE SOTIEN < 14000
GO

--> Cbt 13
--| Q = PHIEUMUON: SOTIEN > 5000 AND MADG = 'DG01' [*]
SELECT * FROM PHIEUMUON
WHERE SOTIEN > 5000
AND MADG = 'DG01'
GO

--> Cbt 14
--| Q = SACH: NXB = 'GIAO DUC' [*]
SELECT * FROM SACH
WHERE NXB = 'GIAO DUC'
GO

--> Cbt 15
--| Q = PHIEUMUON: MASACH = 'CSDL' [*]
SELECT * FROM PHIEUMUON
WHERE MASACH = 'CSDL'
GO

--> Cbt 16
--| Q = DOCGIA: DIACHI LIKE '%Q1%' [*]
SELECT * FROM DOCGIA
WHERE DIACHI LIKE '%Q1%'
GO

--> Cbt 17
--| Q = DOCGIA: DIACHI LIKE '%Q1%' AND PHONE LIKE '0%' [*]
SELECT * FROM DOCGIA
WHERE DIACHI LIKE '%Q1%'
AND PHONE LIKE '0%'
GO

--> Cbt 18
--|	  NXB = NXBAN
--| Q = SACH |><| NXBAN: TENNXB = 'NHA XUAT BAN GIAO DUC' [SACH. *]
SELECT SACH. * FROM SACH, NXBAN
WHERE TENNXB = 'NHA XUAT BAN GIAO DUC'
AND NXB = MANXB
GO

--> Cbt 19
--|	    MADG = MADG
--| Q = DOCGIA |><| PHIEUMUON: HOTEN = 'VO VAN TRON' [PHIEUMUON. *]
SELECT PHIEUMUON. * FROM DOCGIA, PHIEUMUON
WHERE HOTEN = 'VO VAN TRON'
AND DOCGIA. MADG = PHIEUMUON. MADG
GO

--> Cbt 20
--|	    MADG = MADG
--| Q = DOCGIA |><| PHIEUMUON: HOTEN = 'VO VAN TRON' AND SOTIEN > 5000 [PHIEUMUON. *]
SELECT PHIEUMUON. * FROM DOCGIA, PHIEUMUON
WHERE HOTEN = 'VO VAN TRON'
AND SOTIEN > 5000
AND PHIEUMUON. MADG = DOCGIA. MADG
GO

--> Cbt 21
--|	    MADG = MADG
--| Q = DOCGIA |><| PHIEUMUON: DIACHI LIKE '%QPN%' [PHIEUMUON. *]
SELECT PHIEUMUON. * FROM PHIEUMUON, DOCGIA
WHERE DIACHI LIKE '%QPN%'
AND PHIEUMUON. MADG = DOCGIA. MADG
GO

--> Cbt 22
--|	    MADG = MADG
--| Q = DOCGIA |><| PHIEUMUON: DIACHI LIKE '%QPN%'
--| AND MONTH (NGAYMUON) = 4 AND YEAR (NGAYMUON) = 2005 [PHIEUMUON. *]
SELECT PHIEUMUON. * FROM PHIEUMUON, DOCGIA
WHERE DOCGIA. DIACHI LIKE '%QPN%'
AND MONTH (NGAYMUON) = 4
AND YEAR (NGAYMUON) = 2005
AND PHIEUMUON. MADG = DOCGIA. MADG
GO

--> Cbt 23
--|	    MADG = MADG	   MASACH = MASACH
--| Q = (DOCGIA |><| PHIEUMUON) |><| SACH: TENSACH = 'CO SO DU LIEU'
--| AND NGAYTRA - NGAYMUON < 5
SELECT DOCGIA. * FROM DOCGIA, PHIEUMUON, SACH
WHERE NGAYTRA - NGAYMUON < 5
AND TENSACH = 'CO SO DU LIEU'
AND DOCGIA. MADG = PHIEUMUON. MADG
AND SACH. MASACH = PHIEUMUON. MASACH
GO

--> Cbt 24
--> Caf 1
--|	 MASACH = MASACH
--| Q = SACH ||><| PHIEUMUON: PHIEUMUON. MASACH IS NULL
SELECT SACH. * FROM SACH LEFT JOIN PHIEUMUON
ON SACH. MASACH = PHIEUMUON. MASACH
WHERE PHIEUMUON. MASACH IS NULL
GO

--> Caf 2
--|	    MASACH = MASACH
--| Q = PHIEUMUON |><|| SACH: PHIEUMUON. MASACH IS NULL
SELECT SACH. * FROM PHIEUMUON RIGHT JOIN SACH
ON SACH. MASACH = PHIEUMUON. MASACH
WHERE PHIEUMUON. MASACH IS NULL
GO

--> Caf 3
--| Q1 = PHIEUMUON [MASACH]
--| Q = SACH: MASACH NOT IN Q1 [*]
SELECT * FROM SACH
WHERE MASACH NOT IN
	(SELECT MASACH FROM PHIEUMUON)
GO

--> Caf 4
--| S = PHIEUMUON [MASACH]	|
--| R = SACH [MASACH]		|
--| Q1 = R \ S			|(?)
--|	MASACH = MASACH		|
--| Q = SACH |><| Q1 [SACH. *]	|
SELECT * FROM SACH
WHERE NOT EXISTS
	(SELECT * FROM PHIEUMUON
	WHERE SACH. MASACH = PHIEUMUON. MASACH)
GO

--> Cbt 25
--| Q1 = PHIEUMUON [MADG, MASACH]	|
--| Q2 = SACH [MASACH]			|
--| Q3 = Q1 \ Q2			|(?)
--|	MASACH = MASACH			|
--| Q = SACH |><| Q3 [SACH. *]		|
SELECT * FROM DOCGIA AS DG
WHERE NOT EXISTS
	(SELECT * FROM SACH AS S_
	WHERE NOT EXISTS
		(SELECT * FROM PHIEUMUON AS PM
		WHERE DG. MADG = PM. MADG
		AND S_. MASACH = PM. MASACH))
GO

--> Yej dul fcq scs res cbt 25 - Them du lieu de xem ket qua cau 25.
INSERT INTO PHIEUMUON
VALUES('PM002', 'CTDL', 'DG06', '2/4/05', '5/4/05', 7000)
GO

INSERT INTO PHIEUMUON
VALUES('PM002', 'WORD', 'DG06', '2/4/05', '5/4/05', 5000)
GO

INSERT INTO PHIEUMUON
VALUES('PM002', 'TA1', 'DG06', '2/4/05', '5/4/05', 9000)
GO

--> Alk bav hgq tie! - Chuc ban hoc tot!